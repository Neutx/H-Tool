generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  shopifyStoreUrl      String?
  websiteUrl           String?
  hasShopifyDomain     Boolean               @default(true)
  ownerId              String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  cancellationRecords  CancellationRecord[]
  cancellationRequests CancellationRequest[]
  customers            Customer[]
  integrations         Integration[]
  orders               Order[]
  products             Product[]
  rules                Rule[]
  teamMembers          TeamMember[]
  invites              OrganizationInvite[]
  shopifyWebhooks      ShopifyWebhook[]
  syncState            SyncState?

  @@map("organizations")
}

model User {
  id              String          @id @default(cuid())
  firebaseUid     String          @unique
  email           String          @unique
  name            String?
  avatar          String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  teamMemberships TeamMember[]
  sessions        UserSession[]

  @@map("users")
}

enum TeamMemberRole {
  owner
  admin
  member
  viewer
}

model TeamMember {
  id             String          @id @default(cuid())
  role           TeamMemberRole @default(member)
  permissions    Json?
  userId         String
  organizationId String
  invitedBy      String?
  joinedAt       DateTime        @default(now())
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("team_members")
}

model Customer {
  id                   String                @id @default(cuid())
  shopifyCustomerId    String?               @unique
  email                String?
  phone                String?
  name                 String?
  organizationId       String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  cancellationRecords  CancellationRecord[]
  cancellationRequests CancellationRequest[]
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orders               Order[]

  @@map("customers")
}

model Order {
  id                   String                @id @default(cuid())
  shopifyOrderId       String?               @unique
  orderNumber          String
  status               String
  fulfillmentStatus    String
  paymentStatus        String
  totalAmount          Float
  currency             String                @default("INR")
  customerId           String
  organizationId       String
  orderDate            DateTime              @default(now())
  shippingAddress      Json?
  cancelledAt          DateTime?
  cancelReason         String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  cancellationRecords  CancellationRecord[]
  cancellationRequests CancellationRequest[]
  inventoryAdjustments InventoryAdjustment[]
  lineItems            LineItem[]
  orderStatusUpdates   OrderStatusUpdate[]
  customer             Customer              @relation(fields: [customerId], references: [id])
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refundTransactions   RefundTransaction[]
  reviewQueueItems     ReviewQueueItem[]
  shopifyCancellation  ShopifyCancellation?
  shopifyReturns       ShopifyReturn[]

  @@map("orders")
}

model LineItem {
  id                String   @id @default(cuid())
  shopifyLineItemId String?
  orderId           String
  productId         String
  sku               String?
  title             String
  quantity          Int
  price             Float
  totalPrice        Float
  taxAmount         Float?
  inventoryManaged  Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  order             Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product           Product  @relation(fields: [productId], references: [id])

  @@map("line_items")
}

model Product {
  id                   String                @id @default(cuid())
  shopifyProductId     String?               @unique
  sku                  String                @unique
  name                 String
  currentStock         Int                   @default(0)
  availabilityStatus   String                @default("in_stock")
  inventoryManaged     Boolean               @default(true)
  organizationId       String
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  failedSyncs          FailedSync[]
  inventoryAdjustments InventoryAdjustment[]
  lineItems            LineItem[]
  restockRule          ProductRestockRule?
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("products")
}

model CancellationRequest {
  id                 String              @id @default(cuid())
  orderId            String
  customerId         String
  organizationId     String
  reason             String
  reasonCategory     String
  initiatedBy        String
  refundPreference   String
  notes              String?
  status             String              @default("pending")
  riskScore          Float?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  cancellationRecord CancellationRecord?
  customer           Customer            @relation(fields: [customerId], references: [id])
  order              Order               @relation(fields: [orderId], references: [id])
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  reviewQueueItem    ReviewQueueItem?

  @@map("cancellation_requests")
}

model CancellationRecord {
  id                    String              @id @default(cuid())
  cancellationRequestId String              @unique
  orderId               String
  customerId            String
  organizationId        String
  initiatedBy           String
  reason                String
  reasonCategory        String
  refundAmount          Float?
  refundStatus          String?
  restockDecision       String
  completedAt           DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  cancellationRequest   CancellationRequest @relation(fields: [cancellationRequestId], references: [id])
  customer              Customer            @relation(fields: [customerId], references: [id])
  order                 Order               @relation(fields: [orderId], references: [id])
  organization          Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  refundTransactions    RefundTransaction[]

  @@map("cancellation_records")
}

model ReviewQueueItem {
  id                    String              @id @default(cuid())
  cancellationRequestId String              @unique
  orderId               String
  riskLevel             String
  riskIndicators        Json?
  customerHistory       Json?
  reviewStatus          String              @default("pending")
  reviewedBy            String?
  reviewNotes           String?
  reviewedAt            DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  cancellationRequest   CancellationRequest @relation(fields: [cancellationRequestId], references: [id])
  order                 Order               @relation(fields: [orderId], references: [id])

  @@map("review_queue_items")
}

model RefundTransaction {
  id                   String             @id @default(cuid())
  cancellationRecordId String
  orderId              String
  shopifyRefundId      String?
  refundAmount         Float
  taxAmount            Float?
  shippingAmount       Float?
  status               String             @default("pending")
  paymentProcessor     String?
  transactionId        String?
  retryAttempts        Int                @default(0)
  lastRetryAt          DateTime?
  errorMessage         String?
  errorCode            String?
  processedAt          DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  productNames         String?
  refundLineItems      Json?
  shopifyCreatedAt     DateTime?
  shopifyCustomerId    String?
  shopifyNote          String?
  shopifyOrderId       String?
  shopifySyncedAt      DateTime?
  syncedFromShopify    Boolean            @default(false)
  cancellationRecord   CancellationRecord @relation(fields: [cancellationRecordId], references: [id])
  order                Order              @relation(fields: [orderId], references: [id])

  @@map("refund_transactions")
}

model InventoryAdjustment {
  id                  String   @id @default(cuid())
  productId           String
  orderId             String?
  quantityChange      Int
  reason              String
  adjustedBy          String
  notes               String?
  syncedToShopify     Boolean  @default(false)
  syncedToUnicommerce Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  order               Order?   @relation(fields: [orderId], references: [id])
  product             Product  @relation(fields: [productId], references: [id])

  @@map("inventory_adjustments")
}

model ProductRestockRule {
  id               String   @id @default(cuid())
  productId        String   @unique
  neverAutoRestock Boolean  @default(false)
  reason           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_restock_rules")
}

model Rule {
  id                    String        @id @default(cuid())
  organizationId        String
  name                  String
  description           String?
  conditions            Json
  actions               Json
  priority              Int           @default(0)
  active                Boolean       @default(true)
  usageCount            Int           @default(0)
  createdFromTemplateId String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  template              RuleTemplate? @relation(fields: [createdFromTemplateId], references: [id])
  organization          Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("rules")
}

model RuleTemplate {
  id          String   @id @default(cuid())
  name        String
  description String
  category    String
  conditions  Json
  actions     Json
  recommended Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  rules       Rule[]

  @@map("rule_templates")
}

model Integration {
  id                 String              @id @default(cuid())
  organizationId     String
  type               String
  name               String
  config             Json
  syncStatus         String              @default("inactive")
  lastSyncAt         DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  failedSyncs        FailedSync[]
  integrationSyncs   IntegrationSync[]
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orderStatusUpdates OrderStatusUpdate[]

  @@map("integrations")
}

model IntegrationSync {
  id               String      @id @default(cuid())
  integrationId    String
  syncType         String
  status           String
  recordsProcessed Int         @default(0)
  errorMessage     String?
  startedAt        DateTime    @default(now())
  completedAt      DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  integration      Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@map("integration_syncs")
}

model FailedSync {
  id            String      @id @default(cuid())
  integrationId String
  productId     String
  errorMessage  String
  errorCode     String?
  retryCount    Int         @default(0)
  status        String      @default("pending")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  product       Product     @relation(fields: [productId], references: [id])

  @@map("failed_syncs")
}

model OrderStatusUpdate {
  id             String      @id @default(cuid())
  orderId        String
  integrationId  String
  status         String
  trackingNumber String?
  courierPartner String?
  location       String?
  updateDetails  Json?
  timestamp      DateTime    @default(now())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  integration    Integration @relation(fields: [integrationId], references: [id])
  order          Order       @relation(fields: [orderId], references: [id])

  @@map("order_status_updates")
}

model OrganizationInvite {
  id             String       @id @default(cuid())
  organizationId String
  inviteCode     String       @unique
  email          String?
  role           TeamMemberRole @default(member)
  expiresAt      DateTime
  usedAt         DateTime?
  usedBy         String?
  createdBy      String
  createdAt      DateTime     @default(now())
  emailSentAt    DateTime?
  emailSentCount Int          @default(0)
  lastEmailSentAt DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("organization_invites")
}

model UserSession {
  id                 String   @id @default(cuid())
  userId             String
  activeOrganizationId String?
  lastActiveAt       DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId])
  @@map("user_sessions")
}

// Shopify-specific models for webhooks and proper data structure

model ShopifyCancellation {
  id                    String   @id @default(cuid())
  shopifyCancellationId String   @unique
  shopifyOrderId        String   @unique
  cancelledAt           DateTime
  cancelReason          String?
  staffNote             String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  order                 Order    @relation(fields: [shopifyOrderId], references: [shopifyOrderId], onDelete: Cascade)

  @@index([shopifyOrderId])
  @@index([cancelledAt])
  @@map("shopify_cancellations")
}

model ShopifyReturn {
  id               String              @id @default(cuid())
  shopifyReturnId  String              @unique
  shopifyOrderId   String
  status           String              // REQUESTED | APPROVED | RECEIVED | DECLINED
  requestedAt      DateTime
  receivedAt       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  order            Order               @relation(fields: [shopifyOrderId], references: [shopifyOrderId], onDelete: Cascade)
  lineItems        ShopifyReturnLineItem[]

  @@index([shopifyReturnId])
  @@index([shopifyOrderId])
  @@index([requestedAt])
  @@map("shopify_returns")
}

model ShopifyReturnLineItem {
  id                 String         @id @default(cuid())
  shopifyLineItemId  String
  quantity           Int
  reason             String?
  returnId           String
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  return             ShopifyReturn  @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnId])
  @@map("shopify_return_line_items")
}

model ShopifyWebhook {
  id                String       @id @default(cuid())
  organizationId    String
  topic             String       // orders/cancelled, returns/create, returns/update, refunds/create
  shopifyWebhookId  String       @unique
  address           String       // Webhook URL
  status            String       @default("active") // active | inactive
  lastTriggeredAt   DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, topic])
  @@index([organizationId])
  @@index([status])
  @@map("shopify_webhooks")
}

model SyncState {
  id                      String       @id @default(cuid())
  organizationId         String       @unique
  lastCancellationSyncAt DateTime?
  lastReturnSyncAt        DateTime?
  lastRefundSyncAt        DateTime?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("sync_states")
}
